# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

[probe]
pin: PC0
x_offset: 23
y_offset: 5
#z_offset: 0.4
speed: 8.0
samples: 2
samples_result: average
sample_retract_dist: 5.0

[bed_screws]
screw1: 13,6
screw1_name: Front Left
screw2: 13,115
screw1_name: Front Center
screw3: 13,210
screw3_name: Front Right

screw4: 123,6
screw1_name: Center Left
screw5: 123,210
screw3_name: Center Right

screw6: 228,6
screw3_name: Back Left
screw7: 228,115
screw1_name: Back Center
screw8: 228,210
screw3_name: Back Right

[heater_bed]
heater_pin: PD7
sensor_type: NTC 100K beta 3950 ;Generic 3950
sensor_pin: PA1
#control: watermark
min_temp: 0
max_temp: 130
#control: pid
#pid_Kp: 38.85
#pid_Ki: 1.81
#pid_Kd: 557.42
min_temp: 0
max_temp: 110

[fan]
pin: PB7

[heater_fan extruder_fan]
pin: PB6
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

[controller_fan SKR2_fan]
pin: PB5
fan_speed: 1
heater: extruder, heater_bed
# Due to BTT implementing a Marlin-specific safety feature,
# "anti-reversal stepper protection", this pin needs pulling
# high to pass power to stepper drivers and most FETs
[output_pin motor_power]
pin: PC13
value: 1

# These are only safeguards for first time users
# Modify printer.cfg to tune acceleration.
[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000 
max_accel_to_decel: 1500 ; 1500
max_z_velocity:8
max_z_accel: 100

[gcode_arcs]
resolution: 0.25

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 80

[z_tilt]
z_positions: 
    -40,  99
    280, 99
points: 
    5, 99 
    209, 99
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.05

[bed_mesh]
speed: 120
horizontal_move_z: 5
mesh_min: 25, 10
mesh_max: 235, 200
probe_count: 10,10
mesh_pps: 2, 2
algorithm: bicubic
fade_start: 1
fade_end: 10
fade_target: 0
relative_reference_index: 54


[homing_override]
set_position_z: 5
gcode:
    M400                  # Wait for moves to finish
    G90                   # Absolute positioning
    G0 Z10 F600            # Hop Z-Axis
    M204 S1000            # Set homing acceleration (important!)

    # Home X
    SENSORLESS_HOME_X

    # Home Y
    SENSORLESS_HOME_Y
    
    # Prepare Z homing in the middle
    G0 X95.3 Y110.5 F3000
	
    # Rehome Z
    G28 Z
    
    # Safe Z
    G0 Z5 F600

[gcode_macro SENSORLESS_HOME_X]
gcode:
    {% set HOME_CUR = 0.500 %}
    {% set driver_config = printer.configfile.settings['tmc2209 stepper_x'] %}
    {% set RUN_CUR = driver_config.run_current %}
    # Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CUR}
    # Pause to ensure driver stall flag is clear
    G4 P2000
    # Home
    G28 X0
    # Move away
    G90
    G1 X5 F1200
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CUR}

[gcode_macro SENSORLESS_HOME_Y]
gcode:
    {% set HOME_CUR = 0.500 %}
    {% set driver_config = printer.configfile.settings['tmc2209 stepper_y'] %}
    {% set RUN_CUR = driver_config.run_current %}
    # Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CUR}
    # Pause to ensure driver stall flag is clear
    G4 P2000
    # Home
    G28 Y0
    # Move away
    G90
    G1 Y5 F1200
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CUR}

#[safe_z_home]
#home_xy_position: 114 , 99
#z_hop: 5

[output_pin BEEPER_pin]
pin: EXP1_1
#   Beeper pin. This parameter must be provided.
#   ar37 is the default RAMPS/MKS pin.
pwm: True
#   A piezo beeper needs a PWM signal, a DC buzzer doesn't.
value: 0
#   Silent at power on, set to 1 if active low.
shutdown_value: 0
#   Disable at emergency shutdown (no PWM would be available anyway).
cycle_time: 0.001
#   Default PWM frequency : 0.001 = 1ms will give a tone of 1kHz
#   Although not pitch perfect.

[filament_switch_sensor RunoutSensor]
pause_on_runout: false
runout_gcode: 
    # PAUSE
    M118 Filament Runout Detected
    M600
insert_gcode:
    M117 Filament Load Detected
    M118 Filament Load Detected
    M701 # load
#    COUNTDOWN TIME=10 MSG="Clean"
#    RESUME
#    M117 Resuming
#    M118 Resuming
#
#    M117 Printing..
#    M118 Printing..
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=10
 
event_delay: 7.0
pause_delay: 0.01
switch_pin: !PC2

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC5, EXP1_3=PB1, EXP1_5=PE10, EXP1_7=PE12, EXP1_9=<GND>,
    EXP1_2=PB0, EXP1_4=PE9, EXP1_6=PE11, EXP1_8=PE13, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE7, EXP2_5=PB2, EXP2_7=PC4,   EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PA4, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<NC>

# Tools

[skew_correction]

[respond]
default_type: command

[display_status]

[pause_resume]

[force_move]
enable_force_move: True

[idle_timeout]
timeout: 600

[input_shaper]
shaper_freq_x: 40.0 # frequency for the X mark of the test model
shaper_freq_y: 39.5  # frequency for the Y mark of the test model

#[virtual_sdcard]
#path: /home/pi/.octoprint/uploads/

[save_variables]
filename: ~/klipper_config/variables.cfg ; variable storage file